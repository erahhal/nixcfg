#!/usr/bin/env bash

SKIP_WHIPPER=false
ALBUM_DIR=""
NO_COVER_ART=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-whipper|-s)
            SKIP_WHIPPER=true
            shift
            ;;
        --album-dir|-a)
            ALBUM_DIR="$2"
            shift 2
            ;;
        --no-cover-art|-n)
            NO_COVER_ART=true
            shift
            ;;
        --help|-h)
            echo "Usage: rip-cd [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  -s, --skip-whipper     Skip whipper step (for recovery only)"
            echo "  -a, --album-dir DIR    Specify album directory"
            echo "  -n, --no-cover-art     Skip cover art fetching"
            echo "  -h, --help             Show this help"
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Run whipper (unless skipped)
if [[ "$SKIP_WHIPPER" == "false" ]]; then
    COVER_ART_OPT="--cover-art complete"
    if [[ "$NO_COVER_ART" == "true" ]]; then
        COVER_ART_OPT=""
    fi

    whipper -e never cd rip --output-directory ~/Music/Rips $COVER_ART_OPT --unknown --cdr --keep-going "$@"
    WHIPPER_EXIT=$?

    if [[ $WHIPPER_EXIT -ne 0 ]]; then
        echo ""
        echo "WARNING: whipper exited with code $WHIPPER_EXIT"
        echo "If cover art fetch failed, try re-running with: rip-cd --no-cover-art"
        echo ""
    fi
fi

# Find the album directory
if [[ -z "$ALBUM_DIR" ]]; then
    ALBUM_DIR=$(find ~/Music/Rips -mindepth 2 -maxdepth 2 -type d -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)
fi

if [[ -z "$ALBUM_DIR" ]]; then
    echo "Could not find album directory"
    exit 1
fi

echo "Album directory: $ALBUM_DIR"

# Find TOC and CUE files
TOC_FILE=$(find "$ALBUM_DIR" -name "*.toc" | head -1)
CUE_FILE=$(find "$ALBUM_DIR" -name "*.cue" | head -1)

if [[ -z "$TOC_FILE" ]] || [[ -z "$CUE_FILE" ]]; then
    echo "Could not find TOC or CUE file in: $ALBUM_DIR"
    echo ""
    echo "This usually means whipper failed before completing the rip."
    echo "Try one of the following:"
    echo "  1. Re-run with: rip-cd --no-cover-art"
    echo "  2. Delete the album directory and try again"
    exit 1
fi

# Count expected tracks from TOC
EXPECTED_TRACKS=$(grep -c "// Track" "$TOC_FILE")

# Get list of present track numbers from .flac files
PRESENT_TRACKS=$(ls "$ALBUM_DIR"/*.flac 2>/dev/null | sed 's/.*\/\([0-9]\+\)\..*/\1/' | sed 's/^0*//')

# Track recovered files for CUE update
RECOVERED_BASENAMES=()

# Find missing tracks
MISSING_COUNT=0
for i in $(seq 1 $EXPECTED_TRACKS); do
    if ! echo "$PRESENT_TRACKS" | grep -q "^${i}$"; then
        echo "Track $i is missing, attempting recovery..."
        MISSING_COUNT=$((MISSING_COUNT + 1))

        # Get expected filename from CUE (format: FILE "NN. Artist - Track.flac" WAVE)
        PADDED=$(printf "%02d" $i)
        BASENAME=$(grep "^FILE \"${PADDED}\." "$CUE_FILE" | sed 's/FILE "\(.*\)\.flac" WAVE/\1/')

        if [[ -z "$BASENAME" ]]; then
            # Fallback to generic name if not in CUE
            BASENAME="${PADDED}. Unknown Artist - Unknown Track $i"
        fi

        # Rip with cdparanoia
        cdparanoia -v "$i" "$ALBUM_DIR/${BASENAME}-corrupt.wav"

        # Convert to FLAC
        FLAC_FILE="$ALBUM_DIR/${BASENAME}-corrupt.flac"
        flac "$ALBUM_DIR/${BASENAME}-corrupt.wav"

        # Remove intermediate WAV
        rm -f "$ALBUM_DIR/${BASENAME}-corrupt.wav"

        # Add metadata to the recovered FLAC file
        if [[ -f "$FLAC_FILE" ]]; then
            echo "Adding metadata to $FLAC_FILE..."

            # Find a reference FLAC file to copy album-level metadata from
            REF_FLAC=$(find "$ALBUM_DIR" -name "*.flac" ! -name "*-corrupt.flac" | head -1)

            # Extract track info from BASENAME (format: "NN. Artist - Title")
            TRACK_NUM=$(echo "$BASENAME" | sed 's/^\([0-9]\+\)\..*/\1/')
            TRACK_TITLE=$(echo "$BASENAME" | sed 's/^[0-9]\+\. [^-]* - //')
            TRACK_ARTIST=$(echo "$BASENAME" | sed 's/^[0-9]\+\. \([^-]*\) - .*/\1/')

            # Build metaflac command arguments
            METAFLAC_ARGS=(
                "--set-tag=TRACKNUMBER=$TRACK_NUM"
                "--set-tag=TITLE=$TRACK_TITLE"
                "--set-tag=ARTIST=$TRACK_ARTIST"
            )

            # If we have a reference file, copy album-level tags
            if [[ -n "$REF_FLAC" ]] && [[ -f "$REF_FLAC" ]]; then
                ALBUM=$(metaflac --show-tag=ALBUM "$REF_FLAC" 2>/dev/null | sed 's/ALBUM=//')
                ALBUM_ARTIST=$(metaflac --show-tag=album_artist "$REF_FLAC" 2>/dev/null | sed 's/album_artist=//')
                DATE=$(metaflac --show-tag=DATE "$REF_FLAC" 2>/dev/null | sed 's/DATE=//')
                TRACKTOTAL=$(metaflac --show-tag=TRACKTOTAL "$REF_FLAC" 2>/dev/null | sed 's/TRACKTOTAL=//')
                DISCTOTAL=$(metaflac --show-tag=DISCTOTAL "$REF_FLAC" 2>/dev/null | sed 's/DISCTOTAL=//')
                DISC=$(metaflac --show-tag=disc "$REF_FLAC" 2>/dev/null | sed 's/disc=//')

                [[ -n "$ALBUM" ]] && METAFLAC_ARGS+=("--set-tag=ALBUM=$ALBUM")
                [[ -n "$ALBUM_ARTIST" ]] && METAFLAC_ARGS+=("--set-tag=album_artist=$ALBUM_ARTIST")
                [[ -n "$DATE" ]] && METAFLAC_ARGS+=("--set-tag=DATE=$DATE")
                [[ -n "$TRACKTOTAL" ]] && METAFLAC_ARGS+=("--set-tag=TRACKTOTAL=$TRACKTOTAL")
                [[ -n "$DISCTOTAL" ]] && METAFLAC_ARGS+=("--set-tag=DISCTOTAL=$DISCTOTAL")
                [[ -n "$DISC" ]] && METAFLAC_ARGS+=("--set-tag=disc=$DISC")
            fi

            # Apply metadata
            metaflac "${METAFLAC_ARGS[@]}" "$FLAC_FILE"
            echo "Metadata added to $FLAC_FILE"
        fi

        # Update M3U file with the recovered track
        if [[ -f "$FLAC_FILE" ]]; then
            RECOVERED_BASENAMES+=("$BASENAME")

            M3U_FILE=$(find "$ALBUM_DIR" -name "*.m3u" | head -1)
            if [[ -n "$M3U_FILE" ]]; then
                # Get duration in seconds from FLAC metadata
                SAMPLES=$(metaflac --show-total-samples "$FLAC_FILE")
                SAMPLE_RATE=$(metaflac --show-sample-rate "$FLAC_FILE")
                DURATION=$((SAMPLES / SAMPLE_RATE))

                FLAC_FILENAME="${BASENAME}-corrupt.flac"

                # Append entry to M3U
                echo "#EXTINF:${DURATION},${FLAC_FILENAME}" >> "$M3U_FILE"
                echo "${FLAC_FILENAME}" >> "$M3U_FILE"

                echo "Added ${FLAC_FILENAME} to M3U"
            fi
        fi

        echo "Recovered track $i as ${BASENAME}-corrupt.flac"
    fi
done

if [[ $MISSING_COUNT -eq 0 ]]; then
    echo "All tracks present, no recovery needed."
else
    echo "Recovered $MISSING_COUNT track(s)."

    # Re-sort M3U file by track number
    M3U_FILE=$(find "$ALBUM_DIR" -name "*.m3u" | head -1)
    if [[ -n "$M3U_FILE" ]]; then
        echo "Sorting M3U file..."
        # Keep header, combine pairs, sort by track number extracted from filename, split back
        head -1 "$M3U_FILE" > "$M3U_FILE.tmp"
        tail -n +2 "$M3U_FILE" | paste - - | sort -t$'\t' -k2,2 -V | tr '\t' '\n' >> "$M3U_FILE.tmp"
        mv "$M3U_FILE.tmp" "$M3U_FILE"
        echo "M3U file sorted."
    fi

    # Update CUE file with new filenames for recovered tracks
    if [[ ${#RECOVERED_BASENAMES[@]} -gt 0 ]]; then
        echo "Updating CUE file..."
        for BASENAME in "${RECOVERED_BASENAMES[@]}"; do
            # Replace "BASENAME.flac" with "BASENAME-corrupt.flac" in CUE file
            sed -i "s|FILE \"${BASENAME}.flac\" WAVE|FILE \"${BASENAME}-corrupt.flac\" WAVE|g" "$CUE_FILE"
            echo "Updated CUE: ${BASENAME}.flac -> ${BASENAME}-corrupt.flac"
        done
        echo "CUE file updated."
    fi
fi

# If album is in unknown folder, try gnudb.org for metadata
if [[ "$ALBUM_DIR" == *"/unknown/"* ]]; then
    echo ""
    echo "Album is in unknown folder (not found in MusicBrainz)."
    echo "Attempting gnudb.org lookup..."

    LOG_FILE=$(find "$ALBUM_DIR" -name "*.log" | head -1)

    if [[ -n "$LOG_FILE" ]]; then
        # Extract CDDB info from whipper log
        CDDB_ID=$(grep "CDDB Disc ID:" "$LOG_FILE" | sed 's/.*: //')

        if [[ -n "$CDDB_ID" ]]; then
            # Build offsets from "Start sector:" lines + 150 (CDDB offset)
            OFFSETS=$(grep "Start sector:" "$LOG_FILE" | sed 's/.*: //' | awk '{print $1+150}' | tr '\n' '+' | sed 's/+$//')
            TRACK_COUNT=$(grep -c "Start sector:" "$LOG_FILE")

            # Get disc length from log (total sectors / 75 = seconds)
            # Try leadout sector first, fall back to last track's end sector + 150
            TOTAL_SECTORS=$(grep "Leadout sector:" "$LOG_FILE" | sed 's/.*: //')
            if [[ -z "$TOTAL_SECTORS" ]]; then
                # Use last track's end sector + 150 (standard leadout offset)
                LAST_END_SECTOR=$(grep "End sector:" "$LOG_FILE" | tail -1 | sed 's/.*: //')
                if [[ -n "$LAST_END_SECTOR" ]]; then
                    TOTAL_SECTORS=$((LAST_END_SECTOR + 150))
                fi
            fi
            if [[ -n "$TOTAL_SECTORS" ]]; then
                DISC_LENGTH=$((TOTAL_SECTORS / 75))
            else
                DISC_LENGTH=0
            fi

            echo "CDDB ID: $CDDB_ID"
            echo "Track count: $TRACK_COUNT"

            # Query gnudb.org using whipper's registered app name
            # Use GET request with proper URL encoding (+ is space in query string)
            QUERY_RESULT=$(curl -s "http://gnudb.gnudb.org:80/~cddb/cddb.cgi?cmd=cddb+query+${CDDB_ID}+${TRACK_COUNT}+${OFFSETS}+${DISC_LENGTH}&hello=anonymous+localhost+whipper+0.10.0&proto=6")

            echo "Query result: $QUERY_RESULT"

            # Check for match (200 = exact, 210/211 = multiple matches)
            if echo "$QUERY_RESULT" | grep -qE "^2[01][01]"; then
                # Extract category and disc ID from response
                # Response format for 200: "200 category discid Artist / Album"
                # Response format for 210/211: header line, then "category discid Artist / Album"
                if echo "$QUERY_RESULT" | grep -q "^200"; then
                    # Exact match - category is field 2, disc ID is field 3
                    CATEGORY=$(echo "$QUERY_RESULT" | head -1 | awk '{print $2}')
                    DB_DISCID=$(echo "$QUERY_RESULT" | head -1 | awk '{print $3}')
                else
                    # Multiple matches - take first match line after header
                    MATCH_LINE=$(echo "$QUERY_RESULT" | grep -v "^21" | grep -v "^\." | head -1)
                    CATEGORY=$(echo "$MATCH_LINE" | awk '{print $1}')
                    DB_DISCID=$(echo "$MATCH_LINE" | awk '{print $2}')
                fi

                echo "Category: $CATEGORY, DB Disc ID: $DB_DISCID"

                # Read full metadata using the disc ID from the database (not our calculated one)
                GNUDB_DATA=$(curl -s "http://gnudb.gnudb.org:80/~cddb/cddb.cgi?cmd=cddb+read+${CATEGORY}+${DB_DISCID}&hello=anonymous+localhost+whipper+0.10.0&proto=6")

                # Extract metadata (strip \r from CDDB response)
                DTITLE=$(echo "$GNUDB_DATA" | grep "^DTITLE=" | sed 's/DTITLE=//' | tr -d '\r')
                DYEAR=$(echo "$GNUDB_DATA" | grep "^DYEAR=" | sed 's/DYEAR=//' | tr -d '\r')
                DGENRE=$(echo "$GNUDB_DATA" | grep "^DGENRE=" | sed 's/DGENRE=//' | tr -d '\r')

                echo "Found: $DTITLE"
                echo "Year: $DYEAR, Genre: $DGENRE"

                # Parse artist / album from DTITLE
                if echo "$DTITLE" | grep -q " / "; then
                    GNUDB_ARTIST=$(echo "$DTITLE" | sed 's/ \/ .*//')
                    GNUDB_ALBUM=$(echo "$DTITLE" | sed 's/.* \/ //')
                else
                    GNUDB_ARTIST="Unknown Artist"
                    GNUDB_ALBUM="$DTITLE"
                fi

                # Determine if this is a compilation
                IS_COMPILATION=false
                if [[ "$GNUDB_ARTIST" == "Various Artists" ]] || [[ "$GNUDB_ARTIST" == "Various" ]]; then
                    IS_COMPILATION=true
                fi

                # Process each FLAC file
                for FLAC_FILE in "$ALBUM_DIR"/*.flac; do
                    [[ -f "$FLAC_FILE" ]] || continue

                    FILENAME=$(basename "$FLAC_FILE")
                    # Extract track number from filename (format: NN. ...)
                    TRACK_NUM=$(echo "$FILENAME" | sed 's/^\([0-9]\+\)\..*/\1/' | sed 's/^0*//')
                    TRACK_NUM_PADDED=$(printf "%02d" "$TRACK_NUM")

                    # Get track title from gnudb (TTITLE0, TTITLE1, etc. - 0-indexed)
                    TTITLE_INDEX=$((TRACK_NUM - 1))
                    TTITLE=$(echo "$GNUDB_DATA" | grep "^TTITLE${TTITLE_INDEX}=" | sed "s/TTITLE${TTITLE_INDEX}=//" | tr -d '\r')

                    # Parse per-track artist if compilation (format: "Artist - Title" or "Artist / Title")
                    if [[ "$IS_COMPILATION" == "true" ]]; then
                        if echo "$TTITLE" | grep -qF " / "; then
                            TRACK_ARTIST="${TTITLE%% / *}"
                            TRACK_TITLE="${TTITLE#* / }"
                        elif echo "$TTITLE" | grep -qF " - "; then
                            TRACK_ARTIST="${TTITLE%% - *}"
                            TRACK_TITLE="${TTITLE#* - }"
                        else
                            TRACK_ARTIST="$GNUDB_ARTIST"
                            TRACK_TITLE="$TTITLE"
                        fi
                    else
                        TRACK_ARTIST="$GNUDB_ARTIST"
                        TRACK_TITLE="$TTITLE"
                    fi

                    # Fallback if no title found
                    [[ -z "$TRACK_TITLE" ]] && TRACK_TITLE="Track $TRACK_NUM"

                    echo "Track $TRACK_NUM: $TRACK_ARTIST - $TRACK_TITLE"

                    # Remove existing tags and apply new ones
                    metaflac --remove-all-tags "$FLAC_FILE"

                    METAFLAC_ARGS=(
                        "--set-tag=TRACKNUMBER=$TRACK_NUM"
                        "--set-tag=TITLE=$TRACK_TITLE"
                        "--set-tag=ARTIST=$TRACK_ARTIST"
                        "--set-tag=ALBUM=$GNUDB_ALBUM"
                        "--set-tag=TRACKTOTAL=$TRACK_COUNT"
                    )

                    [[ -n "$DYEAR" ]] && METAFLAC_ARGS+=("--set-tag=DATE=$DYEAR")
                    [[ -n "$DGENRE" ]] && METAFLAC_ARGS+=("--set-tag=GENRE=$DGENRE")

                    if [[ "$IS_COMPILATION" == "true" ]]; then
                        METAFLAC_ARGS+=("--set-tag=album_artist=Various Artists")
                        METAFLAC_ARGS+=("--set-tag=COMPILATION=1")
                    else
                        METAFLAC_ARGS+=("--set-tag=album_artist=$GNUDB_ARTIST")
                    fi

                    metaflac "${METAFLAC_ARGS[@]}" "$FLAC_FILE"

                    # Rename file - sanitize title for filename
                    SAFE_TITLE=$(echo "$TRACK_TITLE" | sed 's/[\/\\:*?"<>|]/_/g')
                    if [[ "$IS_COMPILATION" == "true" ]]; then
                        # Compilations: NN. Title.flac (no artist in filename)
                        NEW_FILENAME="${TRACK_NUM_PADDED}. ${SAFE_TITLE}.flac"
                    else
                        # Regular albums: NN. Artist - Title.flac
                        SAFE_ARTIST=$(echo "$TRACK_ARTIST" | sed 's/[\/\\:*?"<>|]/_/g')
                        NEW_FILENAME="${TRACK_NUM_PADDED}. ${SAFE_ARTIST} - ${SAFE_TITLE}.flac"
                    fi

                    if [[ "$FILENAME" != "$NEW_FILENAME" ]]; then
                        mv "$FLAC_FILE" "$ALBUM_DIR/$NEW_FILENAME"
                        echo "Renamed: $FILENAME -> $NEW_FILENAME"
                    fi
                done

                # Regenerate M3U file with current filenames
                M3U_FILE=$(find "$ALBUM_DIR" -name "*.m3u" | head -1)
                if [[ -n "$M3U_FILE" ]]; then
                    echo "Regenerating M3U file..."
                    echo "#EXTM3U" > "$M3U_FILE"
                    for f in "$ALBUM_DIR"/*.flac; do
                        [[ -f "$f" ]] || continue
                        FNAME=$(basename "$f")
                        SAMPLES=$(metaflac --show-total-samples "$f" 2>/dev/null)
                        SAMPLE_RATE=$(metaflac --show-sample-rate "$f" 2>/dev/null)
                        if [[ -n "$SAMPLES" ]] && [[ -n "$SAMPLE_RATE" ]] && [[ "$SAMPLE_RATE" -gt 0 ]]; then
                            DURATION=$((SAMPLES / SAMPLE_RATE))
                        else
                            DURATION=0
                        fi
                        echo "#EXTINF:${DURATION},${FNAME}" >> "$M3U_FILE"
                        echo "${FNAME}" >> "$M3U_FILE"
                    done
                fi

                # Update CUE file with current filenames
                CUE_FILE=$(find "$ALBUM_DIR" -name "*.cue" | head -1)
                if [[ -n "$CUE_FILE" ]]; then
                    echo "Updating CUE file..."
                    for f in "$ALBUM_DIR"/*.flac; do
                        [[ -f "$f" ]] || continue
                        FNAME=$(basename "$f")
                        TNUM=$(echo "$FNAME" | sed 's/^\([0-9]\+\)\..*/\1/')
                        sed -i "s|^FILE \"${TNUM}\. .*\.flac\" WAVE|FILE \"${FNAME}\" WAVE|" "$CUE_FILE"
                    done
                fi

                # Determine destination folder based on type
                RIPS_BASE=~/Music/Rips
                if [[ "$IS_COMPILATION" == "true" ]]; then
                    DEST_TYPE="compilation"
                elif echo "$DGENRE" | grep -iq "soundtrack"; then
                    DEST_TYPE="soundtrack"
                else
                    DEST_TYPE="album"
                fi

                # Sanitize album name for folder
                SAFE_ALBUM=$(echo "$GNUDB_ALBUM" | sed 's/[\/\\:*?"<>|]/_/g')
                SAFE_GNUDB_ARTIST=$(echo "$GNUDB_ARTIST" | sed 's/[\/\\:*?"<>|]/_/g')

                # Build new base name for metadata files
                if [[ "$IS_COMPILATION" == "true" ]]; then
                    NEW_BASENAME="$SAFE_ALBUM"
                    NEW_ALBUM_DIR="$RIPS_BASE/$DEST_TYPE/$SAFE_ALBUM"
                else
                    NEW_BASENAME="$SAFE_GNUDB_ARTIST - $SAFE_ALBUM"
                    NEW_ALBUM_DIR="$RIPS_BASE/$DEST_TYPE/$SAFE_GNUDB_ARTIST - $SAFE_ALBUM"
                fi

                # Rename metadata files (m3u, cue, log, toc)
                for ext in m3u cue log toc; do
                    OLD_FILE=$(find "$ALBUM_DIR" -name "*.$ext" | head -1)
                    if [[ -n "$OLD_FILE" ]]; then
                        NEW_FILE="$ALBUM_DIR/${NEW_BASENAME}.$ext"
                        if [[ "$OLD_FILE" != "$NEW_FILE" ]]; then
                            mv "$OLD_FILE" "$NEW_FILE"
                            echo "Renamed: $(basename "$OLD_FILE") -> ${NEW_BASENAME}.$ext"
                        fi
                    fi
                done

                # Move to new location
                if [[ "$ALBUM_DIR" != "$NEW_ALBUM_DIR" ]]; then
                    mkdir -p "$(dirname "$NEW_ALBUM_DIR")"
                    echo "Moving to: $NEW_ALBUM_DIR"
                    mv "$ALBUM_DIR" "$NEW_ALBUM_DIR"
                    ALBUM_DIR="$NEW_ALBUM_DIR"

                    # Clean up empty unknown folder if empty
                    rmdir ~/Music/Rips/unknown 2>/dev/null || true
                fi

                echo ""
                echo "Successfully tagged and organized album from gnudb.org!"
            else
                echo "Album not found in gnudb.org either."
                echo "You'll need to tag and rename files manually."
                MB_URL=$(grep "MusicBrainz lookup URL:" "$LOG_FILE" | sed 's/.*: //')
                if [[ -n "$MB_URL" ]]; then
                    echo "Submit to MusicBrainz: $MB_URL"
                fi
            fi
        else
            echo "No CDDB ID found in log file."
        fi
    else
        echo "No log file found in album directory."
    fi
fi

echo "Done."
